pipeline {
    agent any

    environment {
        COMPOSE_FILE = 'docker-compose.yml'
    }

    stages {

        stage('Checkout') {
            steps {
                echo 'ğŸ“¦ Clonage du dÃ©pÃ´t...'
                checkout scm
            }
        }

        stage('Build Docker containers') {
            steps {
                echo 'ğŸ³ Construction des conteneurs Docker...'
                bat "docker-compose build"
            }
        }

        stage('Run containers') {
            steps {
                echo 'ğŸš€ Lancement des conteneurs Docker...'
                bat "docker-compose up -d"
            }
        }

        stage('Wait for DB & Run migrations') {
            steps {
                echo 'ğŸ› ï¸ Attente de la base de donnÃ©es & migration Django...'
                bat """
                    sleep 10
                    docker exec django_web python manage.py makemigrations
                    docker exec django_web python manage.py migrate
                """
            }
        }

        stage('Collect static files') {
            steps {
                echo 'ğŸ“‚ Collecte des fichiers statiques...'
                bat "docker exec django_web python manage.py collectstatic --noinput"
            }
        }

        stage('Superuser (optionnel)') {
            steps {
                echo 'ğŸ‘¤ CrÃ©ation du superutilisateur (si scriptÃ©)...'
                // Tu peux ajouter ici une commande pour crÃ©er un superutilisateur automatiquement
                // Exemple :
                // bat "docker exec django_web python manage.py batell < create_superuser.py"
            }
        }
    }

    post {
        success {
            echo 'âœ… Backend Django dÃ©ployÃ© avec succÃ¨s !'
        }
        failure {
            echo 'âŒ Ã‰chec du pipeline Django.'
            bat "docker-compose -f ${COMPOSE_FILE} logs"
        }
        cleanup {
            echo 'ğŸ§¹ Nettoyage si nÃ©cessaire...'
            // Exemple : bat "docker system prune -f"
        }
    }
}
